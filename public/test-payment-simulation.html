<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜æˆåŠŸæ¨¡æ‹Ÿæµ‹è¯• & Webhookæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .secondary-btn {
            background-color: #6c757d;
        }
        .secondary-btn:hover {
            background-color: #545b62;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .result.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .result.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .product-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .product-info h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .product-info p {
            margin: 5px 0;
            color: #6c757d;
        }
        #webhookTestForm {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        #webhookTestForm h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 18px;
        }
        .webhook-btn {
            background-color: #17a2b8;
        }
        .webhook-btn:hover {
            background-color: #138496;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ”¯ä»˜æˆåŠŸæ¨¡æ‹Ÿæµ‹è¯• & Webhookæµ‹è¯•</h1>
        
        <div class="product-info">
            <h3>äº§å“ä¿¡æ¯</h3>
            <p><strong>ä¸€æ¬¡æ€§è´­ä¹°:</strong> 500 ç§¯åˆ† - $6.9</p>
            <p><strong>æœˆåº¦è®¢é˜…:</strong> 500 ç§¯åˆ†/æœˆ - $7.9</p>
            <p><strong>å¹´åº¦è®¢é˜…:</strong> 1000 ç§¯åˆ†/æœˆ - $5.8</p>
            <p><strong>ç”¨æˆ·IDæ ¼å¼:</strong> å¿…é¡»æ˜¯UUIDæ ¼å¼ï¼ˆå¦‚ï¼š12345678-1234-4567-8901-123456789012ï¼‰</p>
        </div>

        <form id="testForm">
            <div class="form-group">
                <label for="productType">äº§å“ç±»å‹ï¼š</label>
                <select id="productType" name="productType">
                    <option value="onetime">ä¸€æ¬¡æ€§è´­ä¹° (500ç§¯åˆ†)</option>
                    <option value="monthly">æœˆåº¦è®¢é˜… (500ç§¯åˆ†/æœˆ)</option>
                    <option value="yearly">å¹´åº¦è®¢é˜… (1000ç§¯åˆ†/æœˆ)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="userId">ç”¨æˆ·ID (å¯é€‰)ï¼š</label>
                <input type="text" id="userId" name="userId" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
            </div>

            <div class="form-group">
                <label for="orderId">è®¢å•ID (å¯é€‰)ï¼š</label>
                <input type="text" id="orderId" name="orderId" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
            </div>

            <button type="submit">ğŸš€ æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ</button>
        </form>

        <form id="webhookTestForm">
            <h2>ğŸ“¡ Webhookæµ‹è¯•</h2>
            <div class="form-group">
                <label for="webhookEventType">Webhookäº‹ä»¶ç±»å‹ï¼š</label>
                <select id="webhookEventType" name="webhookEventType">
                    <option value="checkout.completed">ç»“è´¦å®Œæˆ (checkout.completed)</option>
                    <option value="subscription.active">è®¢é˜…æ¿€æ´» (subscription.active)</option>
                    <option value="subscription.paid">è®¢é˜…ä»˜è´¹ (subscription.paid)</option>
                    <option value="subscription.cancelled">è®¢é˜…å–æ¶ˆ (subscription.cancelled)</option>
                    <option value="subscription.expired">è®¢é˜…è¿‡æœŸ (subscription.expired)</option>
                    <option value="subscription.update">è®¢é˜…æ›´æ–° (subscription.update)</option>
                    <option value="subscription.trialing">è®¢é˜…è¯•ç”¨ (subscription.trialing)</option>
                    <option value="refund.created">é€€æ¬¾åˆ›å»º (refund.created)</option>
                    <option value="dispute.created">äº‰è®®åˆ›å»º (dispute.created)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="webhookProductType">äº§å“ç±»å‹ï¼š</label>
                <select id="webhookProductType" name="webhookProductType">
                    <option value="onetime">ä¸€æ¬¡æ€§è´­ä¹° (500ç§¯åˆ†)</option>
                    <option value="monthly">æœˆåº¦è®¢é˜… (500ç§¯åˆ†/æœˆ)</option>
                    <option value="yearly">å¹´åº¦è®¢é˜… (1000ç§¯åˆ†/æœˆ)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="webhookUserId">ç”¨æˆ·ID (å¯é€‰)ï¼š</label>
                <input type="text" id="webhookUserId" name="webhookUserId" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
            </div>

            <div class="form-group">
                <label for="webhookSubscriptionId">è®¢é˜…ID (å¯é€‰)ï¼š</label>
                <input type="text" id="webhookSubscriptionId" name="webhookSubscriptionId" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
            </div>

            <div class="form-group">
                <label for="webhookOrderId">è®¢å•ID (å¯é€‰)ï¼š</label>
                <input type="text" id="webhookOrderId" name="webhookOrderId" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
            </div>

            <button type="submit" class="webhook-btn">ğŸŒ æ¨¡æ‹ŸWebhookäº‹ä»¶</button>
        </form>

        <button type="button" id="viewTestData" class="secondary-btn">ğŸ“Š æŸ¥çœ‹æµ‹è¯•æ•°æ®</button>

        <div id="result"></div>
    </div>

    <script>
        const API_BASE = '';
        
        // ç”ŸæˆUUIDå‡½æ•°
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // éªŒè¯UUIDæ ¼å¼
        function isValidUUID(uuid) {
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            return uuidRegex.test(uuid);
        }
        
        // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const productType = document.getElementById('productType').value;
            let userId = document.getElementById('userId').value;
            const orderId = document.getElementById('orderId').value;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">â³ æ­£åœ¨æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ...</div>';
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'â³ å¤„ç†ä¸­...';
            
            try {
                // å¦‚æœç”¨æˆ·æä¾›äº†ç”¨æˆ·IDï¼ŒéªŒè¯æ ¼å¼ï¼›å¦åˆ™ä¸ä¼ é€’ï¼Œè®©APIè‡ªåŠ¨ç”ŸæˆUUID
                if (userId && !isValidUUID(userId)) {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>âŒ ç”¨æˆ·IDæ ¼å¼é”™è¯¯</h3>
                            <p>ç”¨æˆ·IDå¿…é¡»æ˜¯æœ‰æ•ˆçš„UUIDæ ¼å¼ï¼Œä¾‹å¦‚ï¼š${generateUUID()}</p>
                            <p>å¦‚æœç•™ç©ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”ŸæˆUUIDæ ¼å¼çš„ç”¨æˆ·IDã€‚</p>
                        </div>
                    `;
                    return;
                }
                
                const params = new URLSearchParams({
                    product_type: productType
                });
                
                if (userId) params.append('user_id', userId);
                if (orderId) params.append('order_id', orderId);
                
                const response = await fetch(`${API_BASE}/api/debug/simulate-payment-success?${params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>âœ… æ”¯ä»˜æˆåŠŸæ¨¡æ‹Ÿå®Œæˆ</h3>
                            <p><strong>ç”¨æˆ·ID:</strong> ${data.testData.userId}</p>
                            <p><strong>è®¢å•ID:</strong> ${data.testData.orderId}</p>
                            <p><strong>äº§å“ç±»å‹:</strong> ${data.testData.productType}</p>
                            <p><strong>ç§¯åˆ†æ•°:</strong> ${data.testData.credits}</p>
                            <p><strong>äº¤æ˜“å·:</strong> ${data.paymentResult.transactionNo}</p>
                            <p><strong>å½“å‰ç§¯åˆ†:</strong> ${data.dataFeedback.statistics.currentCredits}</p>
                            <p><strong>æ´»è·ƒè®¢é˜…:</strong> ${data.dataFeedback.statistics.activeSubscriptions}</p>
                            <p><strong>å®Œæˆè®¢å•:</strong> ${data.dataFeedback.statistics.completedOrders}</p>
                            
                            <details>
                                <summary>ğŸ“‹ è¯¦ç»†æ•°æ®åé¦ˆ</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>âŒ æ¨¡æ‹Ÿå¤±è´¥</h3>
                            <p><strong>é”™è¯¯:</strong> ${data.error}</p>
                            <p><strong>æ¶ˆæ¯:</strong> ${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ è¯·æ±‚å¤±è´¥</h3>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // æ¨¡æ‹ŸWebhookäº‹ä»¶
        document.getElementById('webhookTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const eventType = document.getElementById('webhookEventType').value;
            const productType = document.getElementById('webhookProductType').value;
            const userId = document.getElementById('webhookUserId').value;
            const subscriptionId = document.getElementById('webhookSubscriptionId').value;
            const orderId = document.getElementById('webhookOrderId').value;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">â³ æ­£åœ¨æ¨¡æ‹ŸWebhookäº‹ä»¶...</div>';
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'â³ å¤„ç†ä¸­...';
            
            try {
                // éªŒè¯ç”¨æˆ·IDæ ¼å¼
                if (userId && !isValidUUID(userId)) {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>âŒ ç”¨æˆ·IDæ ¼å¼é”™è¯¯</h3>
                            <p>ç”¨æˆ·IDå¿…é¡»æ˜¯æœ‰æ•ˆçš„UUIDæ ¼å¼ï¼Œä¾‹å¦‚ï¼š${generateUUID()}</p>
                            <p>å¦‚æœç•™ç©ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”ŸæˆUUIDæ ¼å¼çš„ç”¨æˆ·IDã€‚</p>
                        </div>
                    `;
                    return;
                }
                
                // ç”Ÿæˆé»˜è®¤å€¼
                const finalUserId = userId || generateUUID();
                const finalSubscriptionId = subscriptionId || `sub_${Date.now()}`;
                const finalOrderId = orderId || `order_${Date.now()}`;
                const finalCheckoutId = `checkout_${Date.now()}`;
                
                // æ ¹æ®äº§å“ç±»å‹è·å–äº§å“ID
                const productIdMap = {
                    onetime: 'prod_7kbzeBzBsEnWbRA0iTh7wf',
                    monthly: 'prod_6OoADdBXIm16LRR6TN6sFw',
                    yearly: 'prod_6N9SkBhig3ofomadscbGr7'
                };
                
                // æ„å»ºwebhookè¯·æ±‚æ•°æ®
                const webhookData = {
                    eventType: eventType,
                    object: {
                        id: eventType.startsWith('subscription.') ? finalSubscriptionId : finalCheckoutId,
                        customer: {
                            id: finalUserId
                        },
                        product: {
                            id: productIdMap[productType]
                        }
                    }
                };
                
                // ä¸ºä¸åŒäº‹ä»¶ç±»å‹æ·»åŠ ç‰¹å®šå­—æ®µ
                if (eventType === 'checkout.completed') {
                    webhookData.object.subscription = { id: finalSubscriptionId };
                    webhookData.object.order = { id: finalOrderId };
                } else if (eventType.startsWith('subscription.')) {
                    webhookData.object.id = finalSubscriptionId;
                    if (eventType === 'subscription.paid') {
                        webhookData.object.order = { id: finalOrderId };
                        webhookData.object.checkout = { id: finalCheckoutId };
                    }
                } else if (eventType === 'refund.created' || eventType === 'dispute.created') {
                    webhookData.object.subscription = { id: finalSubscriptionId };
                    webhookData.object.order = { id: finalOrderId };
                    webhookData.object.checkout = { id: finalCheckoutId };
                }
                
                const response = await fetch(`${API_BASE}/api/creem/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Creem-Webhook-Test/1.0'
                    },
                    body: JSON.stringify(webhookData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>âœ… Webhookäº‹ä»¶å¤„ç†æˆåŠŸ</h3>
                            <p><strong>äº‹ä»¶ç±»å‹:</strong> ${eventType}</p>
                            <p><strong>ç”¨æˆ·ID:</strong> ${finalUserId}</p>
                            <p><strong>äº§å“ç±»å‹:</strong> ${productType}</p>
                            <p><strong>è®¢é˜…ID:</strong> ${finalSubscriptionId}</p>
                            <p><strong>è®¢å•ID:</strong> ${finalOrderId}</p>
                            <p><strong>å¤„ç†æ—¶é—´:</strong> ${data.processingTime}</p>
                            
                            <details>
                                <summary>ğŸ“‹ Webhookå“åº”è¯¦æƒ…</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                            
                            <details>
                                <summary>ğŸ“¤ å‘é€çš„Webhookæ•°æ®</summary>
                                <pre>${JSON.stringify(webhookData, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>âŒ Webhookäº‹ä»¶å¤„ç†å¤±è´¥</h3>
                            <p><strong>é”™è¯¯:</strong> ${data.error}</p>
                            <p><strong>æ¶ˆæ¯:</strong> ${data.message}</p>
                            <p><strong>å¤„ç†æ—¶é—´:</strong> ${data.processingTime}</p>
                            
                            <details>
                                <summary>ğŸ“¤ å‘é€çš„Webhookæ•°æ®</summary>
                                <pre>${JSON.stringify(webhookData, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ è¯·æ±‚å¤±è´¥</h3>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // æŸ¥çœ‹æµ‹è¯•æ•°æ®
        document.getElementById('viewTestData').addEventListener('click', async () => {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">â³ æ­£åœ¨è·å–æµ‹è¯•æ•°æ®...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/debug/simulate-payment-success`, {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>ğŸ“Š æœ€è¿‘çš„æµ‹è¯•æ•°æ®</h3>
                            <p><strong>æ€»ç§¯åˆ†è®°å½•:</strong> ${data.summary.totalCredits}</p>
                            <p><strong>ç”¨æˆ·æ•°:</strong> ${data.summary.totalProfiles}</p>
                            <p><strong>è®¢é˜…æ•°:</strong> ${data.summary.totalSubscriptions}</p>
                            <p><strong>è®¢å•æ•°:</strong> ${data.summary.totalOrders}</p>
                            
                            <details>
                                <summary>ğŸ“‹ è¯¦ç»†æ•°æ®</summary>
                                <pre>${JSON.stringify(data.data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>âŒ è·å–æ•°æ®å¤±è´¥</h3>
                            <p><strong>é”™è¯¯:</strong> ${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>âŒ è¯·æ±‚å¤±è´¥</h3>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html> 