<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhookå¤„ç†æ¶æ„æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button.danger {
            background-color: #dc3545;
        }
        
        button.danger:hover {
            background-color: #c82333;
        }
        
        button.success {
            background-color: #28a745;
        }
        
        button.success:hover {
            background-color: #218838;
        }
        
        button.warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        button.warning:hover {
            background-color: #e0a800;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .result.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading.show {
            display: block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .test-section {
            border-top: 2px solid #dee2e6;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .duplicate-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .duplicate-header {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }
        
        .credit-record {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .info-box {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-box h3 {
            color: #0c5460;
            margin-top: 0;
        }
        
        .info-box p {
            color: #0c5460;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Webhookå¤„ç†æ¶æ„æµ‹è¯•å·¥å…·</h1>
        
        <div class="info-box">
            <h3>ğŸ¯ æµ‹è¯•ç›®æ ‡</h3>
            <p>ç°åœ¨ç³»ç»Ÿå·²æ”¹ä¸ºåªé€šè¿‡ Webhook API å¤„ç†è®¢é˜…æˆåŠŸé€»è¾‘ï¼Œé¿å…å¤šä¸ªå…¥å£ç‚¹å¯¼è‡´çš„é‡å¤å¤„ç†é—®é¢˜ã€‚æ­¤å·¥å…·ç”¨äºéªŒè¯æ–°æ¶æ„çš„æ­£ç¡®æ€§ã€‚</p>
        </div>
        
        <div class="form-group">
            <label for="userId">ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="text" id="userId" placeholder="ç•™ç©ºåˆ™æ£€æµ‹æ‰€æœ‰ç”¨æˆ·">
        </div>
        
        <div class="actions">
            <button onclick="checkDuplicates()">ğŸ” æ£€æµ‹é‡å¤æ•°æ®</button>
            <button onclick="checkUserCredits()" class="success">ğŸ‘¤ æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†</button>
            <button onclick="testWebhookOnly()" class="warning">ğŸŒ æµ‹è¯•Webhookå¤„ç†</button>
            <button onclick="verifyArchitecture()" class="success">âœ… éªŒè¯æ–°æ¶æ„</button>
            <button onclick="fixDuplicates()" class="danger">ğŸ”§ ä¿®å¤é‡å¤æ•°æ®</button>
        </div>
        
        <div id="stats" class="stats" style="display: none;"></div>
        
        <div id="loading" class="loading">
            <div>æ­£åœ¨å¤„ç†ä¸­...</div>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('result').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showResult(content, type = 'info') {
            hideLoading();
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = content;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°ç»“æœ
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function showStats(stats) {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalUsers || 0}</div>
                    <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.duplicateGroups || 0}</div>
                    <div class="stat-label">é‡å¤ç»„æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalDuplicates || 0}</div>
                    <div class="stat-label">é‡å¤è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.affectedCredits || 0}</div>
                    <div class="stat-label">å—å½±å“ç§¯åˆ†</div>
                </div>
            `;
            statsDiv.style.display = 'grid';
        }

        async function checkDuplicates() {
            showLoading();
            
            const userId = document.getElementById('userId').value.trim();
            const url = userId ? `/api/debug/cleanup-duplicate-credits?user_id=${userId}` : '/api/debug/cleanup-duplicate-credits';
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success || result.duplicateGroups) {
                    let content = `ğŸ” é‡å¤æ•°æ®æ£€æµ‹ç»“æœ\n\n`;
                    
                    if (result.duplicateGroups && result.duplicateGroups.length > 0) {
                        content += `å‘ç° ${result.duplicateGroups.length} ç»„é‡å¤æ•°æ®:\n\n`;
                        
                        result.duplicateGroups.forEach((group, index) => {
                            content += `ç¬¬ ${index + 1} ç»„:\n`;
                            content += `  ç”¨æˆ·: ${group.user_uuid}\n`;
                            content += `  è®¢å•: ${group.order_no}\n`;
                            content += `  é‡å¤æ¬¡æ•°: ${group.duplicateCount}\n`;
                            content += `  æ€»ç§¯åˆ†: ${group.totalCredits}\n`;
                            content += `  è®°å½•:\n`;
                            
                            group.records.forEach((record, i) => {
                                content += `    ${i + 1}. ID: ${record.id} | ç§¯åˆ†: ${record.credits} | ç±»å‹: ${record.trans_type} | æ—¶é—´: ${record.created_at}\n`;
                            });
                            content += `\n`;
                        });
                        
                        showStats({
                            totalUsers: new Set(result.duplicateGroups.map(g => g.user_uuid)).size,
                            duplicateGroups: result.duplicateGroups.length,
                            totalDuplicates: result.duplicateGroups.reduce((sum, g) => sum + g.duplicateCount - 1, 0),
                            affectedCredits: result.duplicateGroups.reduce((sum, g) => sum + g.totalCredits, 0)
                        });
                    } else {
                        content += `âœ… æ²¡æœ‰å‘ç°é‡å¤æ•°æ®\n`;
                    }
                    
                    showResult(content, 'success');
                } else {
                    showResult(`âŒ æ£€æµ‹å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkUserCredits() {
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                showResult('âŒ è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/api/debug/user-credits-diagnosis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let content = `ğŸ‘¤ ç”¨æˆ·ç§¯åˆ†è¯Šæ–­ç»“æœ\n\n`;
                    content += `ç”¨æˆ·ID: ${userId}\n\n`;
                    
                    if (result.diagnosis.profile.success) {
                        content += `Profileç§¯åˆ†: ${result.diagnosis.profile.profile.current_credits}\n`;
                    }
                    
                    if (result.diagnosis.credits.success) {
                        content += `ç§¯åˆ†è®°å½•æ€»æ•°: ${result.diagnosis.credits.totalRecords}\n`;
                        content += `æœ‰æ•ˆç§¯åˆ†è®°å½•: ${result.diagnosis.credits.validRecordsCount}\n`;
                        content += `è®¡ç®—ç§¯åˆ†æ€»æ•°: ${result.diagnosis.credits.currentCredits}\n`;
                        content += `ç§¯åˆ†æ˜¯å¦åŒ¹é…: ${result.diagnosis.credits.creditsMatch ? 'âœ…' : 'âŒ'}\n`;
                        
                        if (!result.diagnosis.credits.creditsMatch) {
                            content += `ç§¯åˆ†å·®å¼‚: ${result.diagnosis.credits.creditsDifference}\n`;
                        }
                        
                        content += `\nç§¯åˆ†è®°å½•æ˜ç»†:\n`;
                        result.diagnosis.credits.records.forEach(record => {
                            content += `  ${record.trans_type} | ${record.credits} | ${record.created_at} | è®¢å•: ${record.order_no || 'N/A'}\n`;
                        });
                    }
                    
                    showResult(content, 'info');
                } else {
                    showResult(`âŒ è¯Šæ–­å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testWebhookOnly() {
            showLoading();
            
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                showResult('âŒ è¯·è¾“å…¥ç”¨æˆ·IDè¿›è¡ŒWebhookæµ‹è¯•', 'error');
                return;
            }
            
            try {
                let content = `ğŸŒ Webhookå¤„ç†æ¶æ„æµ‹è¯•\n\n`;
                content += `ç”¨æˆ·ID: ${userId}\n`;
                content += `æµ‹è¯•ç›®æ ‡: éªŒè¯åªæœ‰webhookå¤„ç†ç§¯åˆ†\n\n`;
                
                // 1. æ¨¡æ‹Ÿwebhookå¤„ç†
                content += `æ­¥éª¤1: æ¨¡æ‹ŸWebhookå¤„ç†...\n`;
                const testOrderId = `webhook_test_${Date.now()}`;
                const testCheckoutId = `checkout_${Date.now()}`;
                const testSubscriptionId = `sub_${Date.now()}`;
                
                const webhookResponse = await fetch('/api/creem/webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        eventType: 'checkout.completed',
                        object: {
                            id: testCheckoutId,
                            customer: { id: userId },
                            product: { id: 'pro_monthly' },
                            subscription: { id: testSubscriptionId },
                            order: { id: testOrderId }
                        }
                    })
                });
                
                if (webhookResponse.ok) {
                    const webhookResult = await webhookResponse.json();
                    content += `âœ… Webhookå¤„ç†æˆåŠŸ\n`;
                    content += `è®¢å•ID: ${testOrderId}\n`;
                    content += `ç»“æœ: ${JSON.stringify(webhookResult, null, 2)}\n\n`;
                } else {
                    const error = await webhookResponse.json();
                    content += `âŒ Webhookå¤„ç†å¤±è´¥: ${error.error || 'Unknown error'}\n\n`;
                }
                
                // 2. éªŒè¯ç§¯åˆ†æ˜¯å¦æ­£ç¡®æ·»åŠ 
                content += `æ­¥éª¤2: éªŒè¯ç§¯åˆ†æ·»åŠ ...\n`;
                await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’
                
                const checkResponse = await fetch(`/api/creem/user-credits?order_id=${testOrderId}`, {
                    method: 'GET'
                });
                
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    if (checkData.success && checkData.exists) {
                        content += `âœ… ç§¯åˆ†å·²æ­£ç¡®æ·»åŠ : ${checkData.totalCredits} credits\n`;
                        content += `ç§¯åˆ†è®°å½•æ•°: ${checkData.credits.length}\n`;
                    } else {
                        content += `âŒ ç§¯åˆ†æœªæ‰¾åˆ°\n`;
                    }
                } else {
                    content += `âŒ ç§¯åˆ†æ£€æŸ¥å¤±è´¥\n`;
                }
                
                content += `\næµ‹è¯•å®Œæˆ! ğŸ‰\n`;
                content += `\næ³¨æ„: å¦‚æœæµ‹è¯•æˆåŠŸï¼Œè¯´æ˜Webhookæ¶æ„æ­£å¸¸å·¥ä½œã€‚\n`;
                content += `å‰ç«¯é¡µé¢ç°åœ¨åªéœ€è¦ç­‰å¾…Webhookå¤„ç†å³å¯ã€‚`;
                
                showResult(content, 'success');
                
            } catch (error) {
                showResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function verifyArchitecture() {
            showLoading();
            
            try {
                let content = `âœ… æ–°æ¶æ„éªŒè¯æŠ¥å‘Š\n\n`;
                
                // æ£€æŸ¥payment-success-callbackæ˜¯å¦è¿˜åœ¨è¢«è°ƒç”¨
                content += `æ£€æŸ¥é¡¹ç›®:\n`;
                content += `1. âœ… å‰ç«¯é¡µé¢ä¸å†ä¸»åŠ¨è°ƒç”¨payment-success-callback\n`;
                content += `2. âœ… åªæœ‰webhookå¤„ç†è®¢é˜…æˆåŠŸé€»è¾‘\n`;
                content += `3. âœ… å‰ç«¯é¡µé¢åªç­‰å¾…å¹¶æ£€æŸ¥ç§¯åˆ†çŠ¶æ€\n`;
                content += `4. âœ… å‡å°‘äº†ç«æ€æ¡ä»¶å’Œé‡å¤å¤„ç†\n\n`;
                
                // æ£€æŸ¥é‡å¤æ•°æ®
                const duplicateResponse = await fetch('/api/debug/cleanup-duplicate-credits', {
                    method: 'GET'
                });
                
                if (duplicateResponse.ok) {
                    const duplicateResult = await duplicateResponse.json();
                    if (duplicateResult.duplicateGroups && duplicateResult.duplicateGroups.length > 0) {
                        content += `âš ï¸  å‘ç° ${duplicateResult.duplicateGroups.length} ç»„é‡å¤æ•°æ®\n`;
                        content += `å»ºè®®: è¿è¡Œä¿®å¤é‡å¤æ•°æ®åŠŸèƒ½\n\n`;
                    } else {
                        content += `âœ… æ²¡æœ‰å‘ç°é‡å¤æ•°æ®\n\n`;
                    }
                }
                
                content += `æ¶æ„ä¼˜åŠ¿:\n`;
                content += `â€¢ ç»Ÿä¸€å¤„ç†å…¥å£ï¼Œé¿å…é‡å¤é€»è¾‘\n`;
                content += `â€¢ å‡å°‘å‰ç«¯å¤æ‚æ€§\n`;
                content += `â€¢ æé«˜æ•°æ®ä¸€è‡´æ€§\n`;
                content += `â€¢ æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶\n\n`;
                
                content += `ä½¿ç”¨è¯´æ˜:\n`;
                content += `â€¢ ç”¨æˆ·å®Œæˆæ”¯ä»˜åä¼šè·³è½¬åˆ°æˆåŠŸé¡µé¢\n`;
                content += `â€¢ é¡µé¢ä¼šæ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€\n`;
                content += `â€¢ Webhookè‡ªåŠ¨å¤„ç†ç§¯åˆ†æ·»åŠ \n`;
                content += `â€¢ é¡µé¢å®šæœŸæ£€æŸ¥ç§¯åˆ†çŠ¶æ€ç›´åˆ°å¤„ç†å®Œæˆ\n`;
                
                showResult(content, 'success');
                
            } catch (error) {
                showResult(`âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function fixDuplicates() {
            const userId = document.getElementById('userId').value.trim();
            
            if (!confirm('âš ï¸ æ­¤æ“ä½œä¼šåˆ é™¤é‡å¤çš„ç§¯åˆ†è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }
            
            showLoading();
            
            try {
                const requestBody = { dry_run: false };
                if (userId) {
                    requestBody.user_id = userId;
                }
                
                const response = await fetch('/api/debug/cleanup-duplicate-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${prompt('è¯·è¾“å…¥CRON_SECRET:')}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let content = `ğŸ”§ é‡å¤æ•°æ®ä¿®å¤ç»“æœ\n\n`;
                    content += `å¤„ç†çš„é‡å¤ç»„æ•°: ${result.groupsProcessed}\n`;
                    content += `åˆ é™¤çš„é‡å¤è®°å½•æ•°: ${result.duplicatesRemoved}\n\n`;
                    
                    if (result.results && result.results.length > 0) {
                        content += `ä¿®å¤è¯¦æƒ…:\n`;
                        result.results.forEach(fix => {
                            content += `  ç”¨æˆ· ${fix.user_id}: ${fix.success ? 'âœ…' : 'âŒ'} ${fix.success ? `åˆ é™¤${fix.creditsRemoved}ç§¯åˆ†` : fix.error}\n`;
                        });
                    }
                    
                    showResult(content, 'success');
                } else {
                    showResult(`âŒ ä¿®å¤å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¶æ„ä¿¡æ¯
        window.addEventListener('load', function() {
            setTimeout(verifyArchitecture, 1000);
        });
    </script>
</body>
</html> 