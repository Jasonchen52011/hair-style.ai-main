<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分系统测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .auth-status.authenticated {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .auth-status.not-authenticated {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button.login {
            background: #28a745;
        }
        .button.login:hover {
            background: #218838;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .credits-display {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }
        .diagnostic-info {
            background: #e2e3e5;
            border: 1px solid #d6d8db;
            padding: 10px;
            border-radius: 5px;
            font-size: 11px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 积分系统测试面板</h1>
        
        <div class="auth-status" id="authStatus">
            正在检查登录状态...
        </div>
        
        <div class="credits-display" id="creditsDisplay">
            当前积分: 加载中...
        </div>

        <div class="test-section">
            <h3>🔐 0. 用户认证状态</h3>
            <button class="button" onclick="checkAuthStatus()">检查认证状态</button>
            <button class="button login" onclick="goToLogin()">前往登录</button>
            <div class="result" id="authResult"></div>
        </div>

        <div class="test-section">
            <h3>📊 1. 检查积分状态</h3>
            <button class="button" onclick="checkCredits()">检查当前积分</button>
            <div class="result" id="checkResult"></div>
        </div>

        <div class="test-section">
            <h3>💰 2. 添加积分（模拟充值）</h3>
            <button class="button" onclick="addCredits(50)">添加 50 积分</button>
            <button class="button" onclick="addCredits(100)">添加 100 积分</button>
            <button class="button" onclick="addCredits(500)">添加 500 积分</button>
            <div class="result" id="addResult"></div>
        </div>

        <div class="test-section">
            <h3>🎨 3. 消费积分（模拟发型生成）</h3>
            <button class="button" onclick="consumeCredits(10)">消费 10 积分</button>
            <button class="button" onclick="consumeCredits(20)">消费 20 积分</button>
            <div class="result" id="consumeResult"></div>
        </div>

        <div class="test-section">
            <h3>🧪 4. 完整流程测试</h3>
            <button class="button" onclick="runFullTest()">运行完整测试</button>
            <div class="result" id="fullTestResult"></div>
        </div>

        <div class="test-section">
            <h3>🔧 5. 系统诊断</h3>
            <button class="button" onclick="runDiagnostics()">运行系统诊断</button>
            <div class="result" id="diagnosticsResult"></div>
        </div>

        <div class="test-section">
            <h3>📋 测试说明</h3>
            <p>• <strong>认证状态</strong>: 检查当前用户是否已登录，这是所有功能的前提</p>
            <p>• <strong>检查积分</strong>: 查看当前用户的积分余额和订阅状态</p>
            <p>• <strong>添加积分</strong>: 模拟用户充值，积分会记录到 credits 表中</p>
            <p>• <strong>消费积分</strong>: 模拟发型生成扣费，验证积分扣减功能</p>
            <p>• <strong>完整测试</strong>: 自动执行：检查积分 → 添加积分 → 消费积分 → 再次检查</p>
            <p>• <strong>系统诊断</strong>: 检查数据库连接、表结构等系统状态</p>
        </div>
    </div>

    <script>
        let isAuthenticated = false;
        let currentCredits = 0;

        // 页面加载时自动检查认证状态
        window.addEventListener('load', function() {
            checkAuthStatus();
        });

        // 更新认证状态显示
        function updateAuthStatus(authenticated, userInfo = null) {
            const authStatus = document.getElementById('authStatus');
            isAuthenticated = authenticated;
            
            if (authenticated) {
                authStatus.className = 'auth-status authenticated';
                authStatus.innerHTML = `✅ 已登录 ${userInfo ? `(用户: ${userInfo.id.substring(0, 8)}...)` : ''}`;
            } else {
                authStatus.className = 'auth-status not-authenticated';
                authStatus.innerHTML = '❌ 未登录 - 请先登录以使用积分功能';
            }
        }

        // 更新积分显示
        function updateCreditsDisplay(credits) {
            const display = document.getElementById('creditsDisplay');
            currentCredits = credits;
            display.textContent = `当前积分: ${credits}`;
        }

        // 显示结果
        function showResult(elementId, message, isSuccess = true, data = null) {
            const element = document.getElementById(elementId);
            let displayMessage = message;
            
            if (data) {
                displayMessage += '\n\n详细信息:\n' + JSON.stringify(data, null, 2);
            }
            
            element.textContent = displayMessage;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            console.log(message, data);
        }

        // 前往登录页面
        function goToLogin() {
            window.open('/signin', '_blank');
        }

        // 检查认证状态
        async function checkAuthStatus() {
            try {
                showResult('authResult', '正在检查认证状态...', true);
                
                const response = await fetch('/api/test-auth');
                const data = await response.json();
                
                if (response.ok) {
                    updateAuthStatus(data.authenticated, data.user);
                    const message = `
认证检查完成
状态: ${data.authenticated ? '已登录' : '未登录'}
用户ID: ${data.user.id || '无'}
邮箱: ${data.user.email || '无'}
错误: ${data.error || '无'}
                    `;
                    showResult('authResult', message.trim(), data.authenticated, data);
                    
                    // 如果已登录，自动检查积分
                    if (data.authenticated) {
                        setTimeout(checkCredits, 500);
                    }
                } else {
                    updateAuthStatus(false);
                    showResult('authResult', `❌ 认证检查失败: ${data.error || 'Unknown error'}`, false, data);
                }
            } catch (error) {
                updateAuthStatus(false);
                showResult('authResult', `❌ 网络错误: ${error.message}`, false);
            }
        }

        // 检查积分
        async function checkCredits() {
            try {
                showResult('checkResult', '正在检查积分...', true);
                
                const response = await fetch('/api/creem/user-credits');
                const data = await response.json();
                
                if (response.ok) {
                    const message = `
✅ 积分检查成功
当前积分: ${data.credits}
活跃订阅: ${data.hasActiveSubscription ? '是' : '否'}
订阅数量: ${data.subscriptions.length}
用户ID: ${data.profile.id}
                    `;
                    showResult('checkResult', message.trim(), true, data);
                    updateCreditsDisplay(data.credits);
                    updateAuthStatus(true, data.profile);
                } else {
                    showResult('checkResult', `❌ 检查失败: ${data.message || data.error}`, false, data);
                    if (response.status === 401) {
                        updateAuthStatus(false);
                    }
                }
            } catch (error) {
                showResult('checkResult', `❌ 网络错误: ${error.message}`, false);
            }
        }

        // 添加积分
        async function addCredits(amount) {
            if (!isAuthenticated) {
                showResult('addResult', '❌ 请先登录才能进行积分操作', false);
                return;
            }

            try {
                showResult('addResult', `正在添加 ${amount} 积分...`, true);
                
                const response = await fetch('/api/creem/user-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        amount: amount,
                        trans_type: 'bonus',
                        order_no: `test_${Date.now()}`
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const message = `
✅ 积分添加成功
添加数量: ${amount}
新的总积分: ${data.totalCredits}
交易号: ${data.transactionNo}
                    `;
                    showResult('addResult', message.trim(), true, data);
                    updateCreditsDisplay(data.totalCredits);
                } else {
                    showResult('addResult', `❌ 添加失败: ${data.message || data.error}`, false, data);
                    if (response.status === 401) {
                        updateAuthStatus(false);
                    }
                }
            } catch (error) {
                showResult('addResult', `❌ 网络错误: ${error.message}`, false);
            }
        }

        // 消费积分
        async function consumeCredits(amount) {
            if (!isAuthenticated) {
                showResult('consumeResult', '❌ 请先登录才能进行积分操作', false);
                return;
            }

            try {
                showResult('consumeResult', `正在消费 ${amount} 积分...`, true);
                
                const response = await fetch('/api/creem/user-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'consume',
                        amount: amount,
                        trans_type: 'hairstyle',
                        order_no: `test_consume_${Date.now()}`
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const message = `
✅ 积分消费成功
消费数量: ${amount}
剩余积分: ${data.remainingCredits}
交易号: ${data.transactionNo}
                    `;
                    showResult('consumeResult', message.trim(), true, data);
                    updateCreditsDisplay(data.remainingCredits);
                } else {
                    showResult('consumeResult', `❌ 消费失败: ${data.message || data.error}`, false, data);
                    if (response.status === 401) {
                        updateAuthStatus(false);
                    }
                }
            } catch (error) {
                showResult('consumeResult', `❌ 网络错误: ${error.message}`, false);
            }
        }

        // 运行完整测试
        async function runFullTest() {
            if (!isAuthenticated) {
                showResult('fullTestResult', '❌ 请先登录才能运行完整测试', false);
                return;
            }

            showResult('fullTestResult', '🚀 开始运行完整测试流程...', true);
            
            try {
                // 步骤1: 检查初始积分
                await new Promise(resolve => setTimeout(resolve, 500));
                await checkCredits();
                
                // 步骤2: 添加积分
                await new Promise(resolve => setTimeout(resolve, 1000));
                await addCredits(100);
                
                // 步骤3: 消费积分
                await new Promise(resolve => setTimeout(resolve, 1000));
                await consumeCredits(10);
                
                // 步骤4: 最终检查
                await new Promise(resolve => setTimeout(resolve, 1000));
                await checkCredits();
                
                showResult('fullTestResult', '✅ 完整测试流程执行完成！请查看各个部分的详细结果。', true);
                
            } catch (error) {
                showResult('fullTestResult', `❌ 完整测试过程中出现错误: ${error.message}`, false);
            }
        }

        // 运行系统诊断
        async function runDiagnostics() {
            try {
                showResult('diagnosticsResult', '🔧 正在运行系统诊断...', true);
                
                // 检查数据库连接
                const dbResponse = await fetch('/api/debug/supabase-test');
                const dbData = await dbResponse.json();
                
                let diagnosticsReport = '=== 系统诊断报告 ===\n\n';
                
                // 数据库连接状态
                diagnosticsReport += '📊 数据库连接状态:\n';
                diagnosticsReport += `- 基本连接: ${dbData.tests?.basicConnection?.success ? '✅ 成功' : '❌ 失败'}\n`;
                diagnosticsReport += `- profiles表: ${dbData.tests?.profiles?.success ? '✅ 正常' : '❌ 异常'}\n`;
                diagnosticsReport += `- subscriptions表: ${dbData.tests?.subscriptions?.success ? '✅ 正常' : '❌ 异常'}\n`;
                
                // 检查credits表
                const creditsResponse = await fetch('/api/debug/check-credits');
                if (creditsResponse.ok) {
                    const creditsData = await creditsResponse.json();
                    diagnosticsReport += `- credits表: ${creditsData.tests?.credits_table?.success ? '✅ 正常' : '❌ 异常'}\n`;
                    diagnosticsReport += `- credits记录数量: ${creditsData.tests?.credits_table?.count || 0}\n`;
                }
                
                // 认证状态
                diagnosticsReport += `\n🔐 认证状态: ${isAuthenticated ? '✅ 已登录' : '❌ 未登录'}\n`;
                
                // 环境变量
                diagnosticsReport += '\n🔧 环境变量状态:\n';
                diagnosticsReport += `- SUPABASE_URL: ${dbData.environmentVariables?.NEXT_PUBLIC_SUPABASE_URL ? '✅ 已配置' : '❌ 未配置'}\n`;
                diagnosticsReport += `- SUPABASE_SERVICE_KEY: ${dbData.environmentVariables?.SUPABASE_SERVICE_ROLE_KEY ? '✅ 已配置' : '❌ 未配置'}\n`;
                
                showResult('diagnosticsResult', diagnosticsReport, true, {dbData, creditsData});
                
            } catch (error) {
                showResult('diagnosticsResult', `❌ 诊断过程中出现错误: ${error.message}`, false);
            }
        }
    </script>
</body>
</html> 