<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .auth-status.authenticated {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .auth-status.not-authenticated {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button.login {
            background: #28a745;
        }
        .button.login:hover {
            background: #218838;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .credits-display {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }
        .diagnostic-info {
            background: #e2e3e5;
            border: 1px solid #d6d8db;
            padding: 10px;
            border-radius: 5px;
            font-size: 11px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® ç§¯åˆ†ç³»ç»Ÿæµ‹è¯•é¢æ¿</h1>
        
        <div class="auth-status" id="authStatus">
            æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...
        </div>
        
        <div class="credits-display" id="creditsDisplay">
            å½“å‰ç§¯åˆ†: åŠ è½½ä¸­...
        </div>

        <div class="test-section">
            <h3>ğŸ” 0. ç”¨æˆ·è®¤è¯çŠ¶æ€</h3>
            <button class="button" onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
            <button class="button login" onclick="goToLogin()">å‰å¾€ç™»å½•</button>
            <div class="result" id="authResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š 1. æ£€æŸ¥ç§¯åˆ†çŠ¶æ€</h3>
            <button class="button" onclick="checkCredits()">æ£€æŸ¥å½“å‰ç§¯åˆ†</button>
            <div class="result" id="checkResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’° 2. æ·»åŠ ç§¯åˆ†ï¼ˆæ¨¡æ‹Ÿå……å€¼ï¼‰</h3>
            <button class="button" onclick="addCredits(50)">æ·»åŠ  50 ç§¯åˆ†</button>
            <button class="button" onclick="addCredits(100)">æ·»åŠ  100 ç§¯åˆ†</button>
            <button class="button" onclick="addCredits(500)">æ·»åŠ  500 ç§¯åˆ†</button>
            <div class="result" id="addResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¨ 3. æ¶ˆè´¹ç§¯åˆ†ï¼ˆæ¨¡æ‹Ÿå‘å‹ç”Ÿæˆï¼‰</h3>
            <button class="button" onclick="consumeCredits(10)">æ¶ˆè´¹ 10 ç§¯åˆ†</button>
            <button class="button" onclick="consumeCredits(20)">æ¶ˆè´¹ 20 ç§¯åˆ†</button>
            <div class="result" id="consumeResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª 4. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <button class="button" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div class="result" id="fullTestResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ 5. ç³»ç»Ÿè¯Šæ–­</h3>
            <button class="button" onclick="runDiagnostics()">è¿è¡Œç³»ç»Ÿè¯Šæ–­</button>
            <div class="result" id="diagnosticsResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>â€¢ <strong>è®¤è¯çŠ¶æ€</strong>: æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œè¿™æ˜¯æ‰€æœ‰åŠŸèƒ½çš„å‰æ</p>
            <p>â€¢ <strong>æ£€æŸ¥ç§¯åˆ†</strong>: æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„ç§¯åˆ†ä½™é¢å’Œè®¢é˜…çŠ¶æ€</p>
            <p>â€¢ <strong>æ·»åŠ ç§¯åˆ†</strong>: æ¨¡æ‹Ÿç”¨æˆ·å……å€¼ï¼Œç§¯åˆ†ä¼šè®°å½•åˆ° credits è¡¨ä¸­</p>
            <p>â€¢ <strong>æ¶ˆè´¹ç§¯åˆ†</strong>: æ¨¡æ‹Ÿå‘å‹ç”Ÿæˆæ‰£è´¹ï¼ŒéªŒè¯ç§¯åˆ†æ‰£å‡åŠŸèƒ½</p>
            <p>â€¢ <strong>å®Œæ•´æµ‹è¯•</strong>: è‡ªåŠ¨æ‰§è¡Œï¼šæ£€æŸ¥ç§¯åˆ† â†’ æ·»åŠ ç§¯åˆ† â†’ æ¶ˆè´¹ç§¯åˆ† â†’ å†æ¬¡æ£€æŸ¥</p>
            <p>â€¢ <strong>ç³»ç»Ÿè¯Šæ–­</strong>: æ£€æŸ¥æ•°æ®åº“è¿æ¥ã€è¡¨ç»“æ„ç­‰ç³»ç»ŸçŠ¶æ€</p>
        </div>
    </div>

    <script>
        let isAuthenticated = false;
        let currentCredits = 0;

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.addEventListener('load', function() {
            checkAuthStatus();
        });

        // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
        function updateAuthStatus(authenticated, userInfo = null) {
            const authStatus = document.getElementById('authStatus');
            isAuthenticated = authenticated;
            
            if (authenticated) {
                authStatus.className = 'auth-status authenticated';
                authStatus.innerHTML = `âœ… å·²ç™»å½• ${userInfo ? `(ç”¨æˆ·: ${userInfo.id.substring(0, 8)}...)` : ''}`;
            } else {
                authStatus.className = 'auth-status not-authenticated';
                authStatus.innerHTML = 'âŒ æœªç™»å½• - è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ç§¯åˆ†åŠŸèƒ½';
            }
        }

        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        function updateCreditsDisplay(credits) {
            const display = document.getElementById('creditsDisplay');
            currentCredits = credits;
            display.textContent = `å½“å‰ç§¯åˆ†: ${credits}`;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, isSuccess = true, data = null) {
            const element = document.getElementById(elementId);
            let displayMessage = message;
            
            if (data) {
                displayMessage += '\n\nè¯¦ç»†ä¿¡æ¯:\n' + JSON.stringify(data, null, 2);
            }
            
            element.textContent = displayMessage;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            console.log(message, data);
        }

        // å‰å¾€ç™»å½•é¡µé¢
        function goToLogin() {
            window.open('/signin', '_blank');
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthStatus() {
            try {
                showResult('authResult', 'æ­£åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...', true);
                
                const response = await fetch('/api/test-auth');
                const data = await response.json();
                
                if (response.ok) {
                    updateAuthStatus(data.authenticated, data.user);
                    const message = `
è®¤è¯æ£€æŸ¥å®Œæˆ
çŠ¶æ€: ${data.authenticated ? 'å·²ç™»å½•' : 'æœªç™»å½•'}
ç”¨æˆ·ID: ${data.user.id || 'æ— '}
é‚®ç®±: ${data.user.email || 'æ— '}
é”™è¯¯: ${data.error || 'æ— '}
                    `;
                    showResult('authResult', message.trim(), data.authenticated, data);
                    
                    // å¦‚æœå·²ç™»å½•ï¼Œè‡ªåŠ¨æ£€æŸ¥ç§¯åˆ†
                    if (data.authenticated) {
                        setTimeout(checkCredits, 500);
                    }
                } else {
                    updateAuthStatus(false);
                    showResult('authResult', `âŒ è®¤è¯æ£€æŸ¥å¤±è´¥: ${data.error || 'Unknown error'}`, false, data);
                }
            } catch (error) {
                updateAuthStatus(false);
                showResult('authResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // æ£€æŸ¥ç§¯åˆ†
        async function checkCredits() {
            try {
                showResult('checkResult', 'æ­£åœ¨æ£€æŸ¥ç§¯åˆ†...', true);
                
                const response = await fetch('/api/creem/user-credits');
                const data = await response.json();
                
                if (response.ok) {
                    const message = `
âœ… ç§¯åˆ†æ£€æŸ¥æˆåŠŸ
å½“å‰ç§¯åˆ†: ${data.credits}
æ´»è·ƒè®¢é˜…: ${data.hasActiveSubscription ? 'æ˜¯' : 'å¦'}
è®¢é˜…æ•°é‡: ${data.subscriptions.length}
ç”¨æˆ·ID: ${data.profile.id}
                    `;
                    showResult('checkResult', message.trim(), true, data);
                    updateCreditsDisplay(data.credits);
                    updateAuthStatus(true, data.profile);
                } else {
                    showResult('checkResult', `âŒ æ£€æŸ¥å¤±è´¥: ${data.message || data.error}`, false, data);
                    if (response.status === 401) {
                        updateAuthStatus(false);
                    }
                }
            } catch (error) {
                showResult('checkResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // æ·»åŠ ç§¯åˆ†
        async function addCredits(amount) {
            if (!isAuthenticated) {
                showResult('addResult', 'âŒ è¯·å…ˆç™»å½•æ‰èƒ½è¿›è¡Œç§¯åˆ†æ“ä½œ', false);
                return;
            }

            try {
                showResult('addResult', `æ­£åœ¨æ·»åŠ  ${amount} ç§¯åˆ†...`, true);
                
                const response = await fetch('/api/creem/user-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        amount: amount,
                        trans_type: 'bonus',
                        order_no: `test_${Date.now()}`
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const message = `
âœ… ç§¯åˆ†æ·»åŠ æˆåŠŸ
æ·»åŠ æ•°é‡: ${amount}
æ–°çš„æ€»ç§¯åˆ†: ${data.totalCredits}
äº¤æ˜“å·: ${data.transactionNo}
                    `;
                    showResult('addResult', message.trim(), true, data);
                    updateCreditsDisplay(data.totalCredits);
                } else {
                    showResult('addResult', `âŒ æ·»åŠ å¤±è´¥: ${data.message || data.error}`, false, data);
                    if (response.status === 401) {
                        updateAuthStatus(false);
                    }
                }
            } catch (error) {
                showResult('addResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // æ¶ˆè´¹ç§¯åˆ†
        async function consumeCredits(amount) {
            if (!isAuthenticated) {
                showResult('consumeResult', 'âŒ è¯·å…ˆç™»å½•æ‰èƒ½è¿›è¡Œç§¯åˆ†æ“ä½œ', false);
                return;
            }

            try {
                showResult('consumeResult', `æ­£åœ¨æ¶ˆè´¹ ${amount} ç§¯åˆ†...`, true);
                
                const response = await fetch('/api/creem/user-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'consume',
                        amount: amount,
                        trans_type: 'hairstyle',
                        order_no: `test_consume_${Date.now()}`
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const message = `
âœ… ç§¯åˆ†æ¶ˆè´¹æˆåŠŸ
æ¶ˆè´¹æ•°é‡: ${amount}
å‰©ä½™ç§¯åˆ†: ${data.remainingCredits}
äº¤æ˜“å·: ${data.transactionNo}
                    `;
                    showResult('consumeResult', message.trim(), true, data);
                    updateCreditsDisplay(data.remainingCredits);
                } else {
                    showResult('consumeResult', `âŒ æ¶ˆè´¹å¤±è´¥: ${data.message || data.error}`, false, data);
                    if (response.status === 401) {
                        updateAuthStatus(false);
                    }
                }
            } catch (error) {
                showResult('consumeResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            if (!isAuthenticated) {
                showResult('fullTestResult', 'âŒ è¯·å…ˆç™»å½•æ‰èƒ½è¿è¡Œå®Œæ•´æµ‹è¯•', false);
                return;
            }

            showResult('fullTestResult', 'ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...', true);
            
            try {
                // æ­¥éª¤1: æ£€æŸ¥åˆå§‹ç§¯åˆ†
                await new Promise(resolve => setTimeout(resolve, 500));
                await checkCredits();
                
                // æ­¥éª¤2: æ·»åŠ ç§¯åˆ†
                await new Promise(resolve => setTimeout(resolve, 1000));
                await addCredits(100);
                
                // æ­¥éª¤3: æ¶ˆè´¹ç§¯åˆ†
                await new Promise(resolve => setTimeout(resolve, 1000));
                await consumeCredits(10);
                
                // æ­¥éª¤4: æœ€ç»ˆæ£€æŸ¥
                await new Promise(resolve => setTimeout(resolve, 1000));
                await checkCredits();
                
                showResult('fullTestResult', 'âœ… å®Œæ•´æµ‹è¯•æµç¨‹æ‰§è¡Œå®Œæˆï¼è¯·æŸ¥çœ‹å„ä¸ªéƒ¨åˆ†çš„è¯¦ç»†ç»“æœã€‚', true);
                
            } catch (error) {
                showResult('fullTestResult', `âŒ å®Œæ•´æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, false);
            }
        }

        // è¿è¡Œç³»ç»Ÿè¯Šæ–­
        async function runDiagnostics() {
            try {
                showResult('diagnosticsResult', 'ğŸ”§ æ­£åœ¨è¿è¡Œç³»ç»Ÿè¯Šæ–­...', true);
                
                // æ£€æŸ¥æ•°æ®åº“è¿æ¥
                const dbResponse = await fetch('/api/debug/supabase-test');
                const dbData = await dbResponse.json();
                
                let diagnosticsReport = '=== ç³»ç»Ÿè¯Šæ–­æŠ¥å‘Š ===\n\n';
                
                // æ•°æ®åº“è¿æ¥çŠ¶æ€
                diagnosticsReport += 'ğŸ“Š æ•°æ®åº“è¿æ¥çŠ¶æ€:\n';
                diagnosticsReport += `- åŸºæœ¬è¿æ¥: ${dbData.tests?.basicConnection?.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;
                diagnosticsReport += `- profilesè¡¨: ${dbData.tests?.profiles?.success ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}\n`;
                diagnosticsReport += `- subscriptionsè¡¨: ${dbData.tests?.subscriptions?.success ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}\n`;
                
                // æ£€æŸ¥creditsè¡¨
                const creditsResponse = await fetch('/api/debug/check-credits');
                if (creditsResponse.ok) {
                    const creditsData = await creditsResponse.json();
                    diagnosticsReport += `- creditsè¡¨: ${creditsData.tests?.credits_table?.success ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}\n`;
                    diagnosticsReport += `- creditsè®°å½•æ•°é‡: ${creditsData.tests?.credits_table?.count || 0}\n`;
                }
                
                // è®¤è¯çŠ¶æ€
                diagnosticsReport += `\nğŸ” è®¤è¯çŠ¶æ€: ${isAuthenticated ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}\n`;
                
                // ç¯å¢ƒå˜é‡
                diagnosticsReport += '\nğŸ”§ ç¯å¢ƒå˜é‡çŠ¶æ€:\n';
                diagnosticsReport += `- SUPABASE_URL: ${dbData.environmentVariables?.NEXT_PUBLIC_SUPABASE_URL ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n`;
                diagnosticsReport += `- SUPABASE_SERVICE_KEY: ${dbData.environmentVariables?.SUPABASE_SERVICE_ROLE_KEY ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n`;
                
                showResult('diagnosticsResult', diagnosticsReport, true, {dbData, creditsData});
                
            } catch (error) {
                showResult('diagnosticsResult', `âŒ è¯Šæ–­è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, false);
            }
        }
    </script>
</body>
</html> 